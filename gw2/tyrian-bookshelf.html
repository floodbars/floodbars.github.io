<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Tyrian Bookshelf</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    
    <!-- Don't use this in production: -->
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <style>
      li.complete {
        font-weight: bold;
      }
      li.locked {
        opacity: 0.3;
      }
      div.preview {
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div id="root" class="container"></div>
    <script type="text/babel">

    // TODO: metadata on how to unlock the achievements
    const BOOKS = [
      {
        "name": "Book 01",
        "type": "book",
        "text": "The text of the book."
      },
      {
        "name": "Book 02",
        "type": "book",
        "text": "The text of the book."
      },
      {
        "name": "Book A",
        "type": "book",
        "text": "More book text."
      },
      {
        "name": "Book B",
        "type": "book",
        "text": "More book text."
      },
      {
        "name": "Book C",
        "type": "paged",
        "text": [
          {
            "description": "Book C, Vol. 1",
            "page": 1,
            "text": "The text of the first page."
          },
          {
            "description": "Book C, Vol. 2",
            "page": 2,
            "text": "More book text from the second page."
          }
        ]
      },
      {
        "name": "Paged Book A",
        "type": "paged",
        "text": [
          {
            "text": "The text of the first page.",
            "page": 1
          },
          {
            "text": "More book text from the second page.",
            "page": 2
          }
        ]
      }
    ];
    const ACHIEVEMENTS = [
      {
        "achievementId": 1,
        "name": "An Achievement",
        "bits": [
          {
            "type": "Achievement"
          },
          {
            "id": 102,
            "book": "Book 01"
          },
          {
            "id": 103,
            "book": "Book A"
          },
        ]
      },
      {
        "achievementId": 2,
        "name": "Another Achievement",
        "bits": [
          {
            "id": 104,
            "book": "Book 02"
          },
          {
            "id": 105,
            "book": "Book B"
          },
        ]
      },
      {
        "achievementId": 3,
        "name": "Yet Another Achievement",
        "bits": [
          {
            "id": 106,
            "book": "Book C",
            "page": 1
          },
          {
            "id": 107,
            "book": "Book C",
            "page": 2
          },
        ]
      },
      {
        "achievementId": 4,
        "name": "YAA",
        "bits": [
          {
            "type": "Achievement"
          },
          {
            "id": 108,
            "book": "Paged Book A",
            "page": 1
          },
          {
            "id": 109,
            "book": "Paged Book A",
            "page": 2
          },
        ]
      },
    ];

    const testAchievementData = [
      {
        bits: [],
        current: 3,
        done: true,
        id: 1,
        max: 3
      },
      {
        bits: [1],
        current: 1,
        done: false,
        id: 2,
        max: 2
      },
      {
        bits: [],
        current: 2,
        done: true,
        id: 3,
        max: 2
      },
      {
        bits: [2],
        current: 3,
        done: false,
        id: 4,
        max: 3
      },
    ];

      function mapAchievementsToBooks(progression) {
        var achievements = {};
        ACHIEVEMENTS.forEach(x => achievements[x.achievementId] = x);

        var books = {};
        var output = [];
        BOOKS.forEach(x => {
          const book = {...x, status: "locked"};
          output.push(book);
          books[x.name] = book;
        });
        // TODO: book, paged, collation (multiple disparate things)

        progression.forEach(progress => {
          var achievement = achievements[progress.id];
          achievement["bits"]
            .map((bit, index) => {
              var isDone = progress["done"] || progress["bits"].includes(index + 1);
              if (isDone) {
                var bookName = bit["book"];
                if (bookName) {
                  if (bit["page"]) {
                    books[bookName].text.find(x => x.page == bit.page).isUnlocked = true;
                  } else {
                    books[bookName].status = "complete";
                  }
                }
              }
            });
            if (progress.done && achievement.unlockOnCompletion) {
              achievement.unlockOnCompletion.forEach(bit => {
                var bookName = bit["book"];
                books[bookName].text.find(x => x.page == bit.page).isUnlocked = true;
              });
            }
        });

        output.forEach(book => {
          if (book.type == "paged") {
            const unlockedPages = book.text.filter(x => x.isUnlocked).length;
            const isComplete = unlockedPages > 0
            if (unlockedPages == 0) {
              // remain locked
            } else if (unlockedPages == book.text.length) {
              book.status = "complete";
            } else {
              book.status = "partial";
            }
          } else if (book.type == "book-paged") {
            if (book.status == "complete") {
              book.text.forEach(x => x.isUnlocked = true);
            }
          }
        });
        return output;
      }

      class BookPreview extends React.Component {
        render() {
          const book = this.props.value;
          return (
            <div className="col-sm-8">
              <div className="card">
                <div className="preview card-body">
                  <h4 className="card-title">{book.name}</h4>
                  {book.text}
                </div>
              </div>
            </div>
          );
        }
      }

      class LockedBookPreview extends React.Component {

        render() {
          var book = this.props.book;
          return (
            <div className="col-sm-8">
              <div className="card border-warning">
                <div className="card-body text-warning">
                  <h4 className="card-title">{book.name}</h4>
                  You have yet to acquire this book.
                </div>
              </div>
            </div>
          );
        }

      }

      class PagedBookPreview extends React.Component {

        render() {
          var book = this.props.book;
          if (!book) {
            return ("Uh-oh");
          }

          return (
            <div className="col-sm-8">
              <div className="card">
                <div className="card-body">
                  <h4 className="card-title">{book.name}</h4>
                  {book.text.map(page => (
                    <Page page={page} key={page.page} />
                  ))}
                </div>
              </div>
            </div>
          );
        }
      }

      class Page extends React.Component {
        render() {
          var text = "Page Missing";
          var style = "warning";
          if (this.props.page.isUnlocked) {
            text = this.props.page.text;
            style = "primary";
          }
          return (
            <div className={"card mb-3 border-" + style}>
              {this.props.page.description &&
                <div className="card-header">{this.props.page.description}</div>
              }
              <div className="preview card-body">
                {text}
              </div>
            </div>
          );
        }
      }

      class CodexApp extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            apiKey: 'UNLOCK_ALL'
          };
          this.handleChange = this.handleChange.bind(this);
          this.handleSubmit = this.handleSubmit.bind(this);
        }

        render() {
          return (
            <div>
              <h1>Codex</h1>
              <form onSubmit={this.handleSubmit}>
                <div className="form-group">
                <label htmlFor="api-key">
                  API Key
                </label>
                <input
                  id="api-key"
                  className="form-control"
                  onChange={this.handleChange}
                  value={this.state.apiKey}
                />
                </div>
                <button type="submit" className="btn btn-primary">
                  Load
                </button>
              </form>
            </div>
          );
        }

        handleChange(e) {
          this.setState({ apiKey: e.target.value });
        }

        handleSubmit(e) {
          e.preventDefault();
          if (!this.state.apiKey.length) {
            return;
          }
          this.setState(state => ({
            apiKey: state.apiKey
          }));
          ReactDOM.render(
            <Shelf apiKey={this.state.apiKey} />,
            document.getElementById('root')
          );
        }
      }

      class Shelf extends React.Component {
        constructor(props) {
          super(props);
          this.apiKey = props.apiKey;

          this.state = {
            achievements: [], isLoaded: false,
            error: null,
            preview: null
          };
        }
        componentDidMount() {
          if (this.apiKey == 'UNLOCK_ALL') {
            const allUnlocked = ACHIEVEMENTS.map(x => {
                return {
                  bits: [],
                  current: x.bits.length,
                  done: true,
                  id: x.achievementId,
                  max: x.bits.length
                }
              });
            this.setState({
              achievements: allUnlocked,
              isLoaded: true
            });
            return;
          } else if (this.apiKey == 'UNLOCK_NONE') {
            this.setState({
              achievements: [],
              isLoaded: true
            });
            return;
          } else if (this.apiKey == 'UNLOCK_SOME') {
            this.setState({
              achievements: testAchievementData,
              isLoaded: true
            });
            return;
          }
          // TODO move this to a GW2 API class?
          var url = "https://api.guildwars2.com/v2/account/achievements?"
            + "ids=" + ACHIEVEMENTS.map(x => x["achievementId"]).join(",")
            + "&access_token=" + this.apiKey;
          fetch(url)
            .then(res => res.json())
            .then(
              (result) => {
                this.setState({
                  achievements: result,
                  isLoaded: true
                });
              },
              // Note: it's important to handle errors here
              // instead of a catch() block so that we don't swallow
              // exceptions from actual bugs in components.
              (error) => {
                this.setState({
                  isLoaded: true,
                  error
                });
              }
            )
        }
        
        renderPreview() {
          var book = this.state.preview;
          if (!book) {
            return;
          }

          if (book.status == "locked") {
            return (
              <LockedBookPreview book={book} />
            );
          }

          if (book.type == "paged" || book.type == "book-paged") {
            return (
              <PagedBookPreview book={book} />
            );
          } else {
            return (
              <BookPreview value={book} />
            );
          }
        }
        
        previewBook(book) {
          var newState = {
            achievements: this.state.achievements,
            isLoaded: this.state.isLoaded,
            error: this.state.error,
            preview: book
          };
          this.setState(newState);
        }

        render() {
          const { error, isLoaded, achievements, preview } = this.state;
          if (error) {
            return <div>Error: {error.message}</div>;
          } else if (!isLoaded) {
            return <div>Loading...</div>;
          } else {
            // TODO map achievement ids to books
            var books = mapAchievementsToBooks(achievements);
            books.sort((x, y) => x["name"].localeCompare(y["name"]));
            return (
              <div className="codex container">
                <div className="row">
                  <h2>Tyrian Bookshelf</h2>
                </div>
                <div className="row">
                <div className="col-sm-4">
                  <div className="list-group mh-100">
                    {books.map(book => (
                      <Book key={book.name} value={book} onClick={() => this.previewBook(book)} />
                    ))}
                  </div>
                </div>
                {this.renderPreview()}
              </div>
              </div>
            );
          }
        }
      }

      class Book extends React.Component {
        constructor(props) {
          super(props);
          this.state = props.value;
          this.onClick = props.onClick;
        }

        render() {
          var context = "light";
          switch (this.state.status) {
            case "partial":
              context = "secondary";
              break;
            case "complete":
              context = "primary";
              break;
          }

          // TODO set active highlight somehow?
          return (
            <a href="#" className={"list-group-item-" + context + " list-group-item d-flex justify-content-between align-items-center"}
                onClick={this.onClick}>
              {this.state.name}
              {(this.state.status == "partial") &&
                <span className="badge badge-warning badge-pill">
                  {this.state.text.filter(x => !x.isUnlocked).length}
                </span>
              }
            </a>
          );
        }
      }

      ReactDOM.render(
        <CodexApp />,
        document.getElementById('root')
      );

    </script>
    <!--
      Note: this page is a great way to try React but it's not suitable for production.
      It slowly compiles JSX with Babel in the browser and uses a large development build of React.

      Read this section for a production-ready setup with JSX:
      https://reactjs.org/docs/add-react-to-a-website.html#add-jsx-to-a-project

      In a larger project, you can use an integrated toolchain that includes JSX instead:
      https://reactjs.org/docs/create-a-new-react-app.html

      You can also use React without JSX, in which case you can remove Babel:
      https://reactjs.org/docs/react-without-jsx.html
    -->
  </body>
</html>