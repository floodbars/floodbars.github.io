<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Tyrian Bookshelf</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    
    <!-- Don't use this in production: -->
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <style>
      li.complete {
        font-weight: bold;
      }
      li.locked {
        opacity: 0.3;
      }
      div.preview {
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
    // TODO: metadata on how to unlock the achievements
    const relevantAchievements = [
      {
        "achievementId": 1,
        "name": "An Achievement",
        "collectionType": "books",
        "bits": [
          {
            "type": "Achievement"
          },
          {
            "type": "Item",
            "id": 102,
            "name": "Book 01",
            "text": "The text of the book."
          },
          {
            "type": "Item",
            "id": 103,
            "name": "Book A",
            "text": "More book text."
          },
        ]
      },
      {
        "achievementId": 2,
        "name": "An Achievement",
        "collectionType": "books",
        "bits": [
          {
            "type": "Achievement"
          },
          {
            "type": "Item",
            "id": 104,
            "name": "Book 02",
            "text": "The text of the book."
          },
          {
            "type": "Item",
            "id": 105,
            "name": "Book B",
            "text": "More book text."
          },
        ]
      },
    ];

      function mapAchievementsToBooks(progression) {
        return relevantAchievements.map(achievement => {
          var progress = progression
            .filter(x => (x["id"] == achievement["achievementId"]))
            .shift();
          switch (achievement["collectionType"]) {
            case "books":
              return achievement["bits"]
                .filter(x => x["type"] == "Item")
                .map((x, index) => {
                  var status = "locked";
                  if (progress == null) {
                    status = "locked";
                  } else if (progress["done"]) {
                    status = "complete";
                  } else if (progress["bits"].includes(index + 1)) {
                    status = "complete";
                  }

                  return {
                    name: x.name,
                    status: status,
                    data: x,
                    type: x["collectionType"]
                  };
                });
              break;
            case "pages":
              var status = "locked";
              var completion = "";
              var bits = null;

              if (progress == null) {
                // skip
              } else if (progress["done"]) {
                status = "complete";
              } else if (progress["current"] > 0) {
                status = "partial";
                completion = " [" + progress["current"] + "/" + progress["max"] + "]";
                bits = progress["bits"];
              }

              var book = {
                name: achievement.name + completion,
                status: status,
                bits: bits,
                data: achievement,
                type: achievement["collectionType"]
              };
              return book;
              break;
            default:
              // Hm....
          }
          return [{"name": "something broke"}];
        }).flat(1);
      }

      class Book extends React.Component {
        constructor(props) {
          super(props);
          this.state = props.value;
          this.onClick = props.onClick;
        }

        render() { 
          return (
            <li className={this.state.status} onClick={this.onClick}>
              <span className="book">
                {this.state.name}
              </span>
            </li>
          );
        }
      }

      class BookPreview extends React.Component {
        render() {
          var book = this.props.value;
          var text = "";
          var title = "";
          if (book) {
            title = book.name;
            switch (book.status) {
            case "locked":
              text = "You have yet to acquire this book.";
              break;
            case "partial":
              text = "This shouldn't happen; this is really only applicable for pages...";
              break;
            case "complete":
              text = book.data.text;
              break;
            }
          }
          return (
            <div>
              <h2>Preview</h2>
              <h3>{title}</h3>
              <div className="preview">
                {text}
              </div>
            </div>
          );
        }
      }

      class PagedBookPreview extends React.Component {
        constructor(props) {
          super(props);
          this.state = {page: 1};
          this.handlePrev = this.handlePrev.bind(this);
          this.handleNext = this.handleNext.bind(this);
        }

        isPrevDisabled() {
          return !this.props.book || this.state.page == 1;
        }

        isNextDisabled() {
          var max = this.props.book.data.pages.length;
          return !this.props.book || this.state.page >= max;
        }

        handlePrev() {
          this.updatePage(this.state.page - 1);
        }

        handleNext() {
          this.updatePage(this.state.page + 1);
        }

        updatePage(newPage) {
          if (this.props.book) {
            var max = this.props.book.data.pages.length;
            if (newPage < 1) {
              newPage = 1;
            } else if (newPage > max) {
              newPage = max;
            }
            this.setState({page: newPage});
          }
        }

        render() {
          var book = this.props.book;
          var text = "";
          var title = "";
          var isUnlocked = false;
          if (book) {
            title = book.name;
            switch (book.status) {
            case "locked":
              text = "You have yet to acquire this book.";
              break;
            case "partial":
              if (book.bits.includes(this.state.page)) {
                isUnlocked = true;
              } else {
                text = "Page Missing";
              }
              break;
            case "complete":
              isUnlocked = true;
              break;
            }
          }
          // TODO what to do with description?
          if (isUnlocked) {
            text = book.data.pages[this.state.page-1].text;
          }
          return (
            <div>
              <h2>Preview</h2>
              <h3>{title}</h3>
              <center>
                <button
                  disabled={this.isPrevDisabled()}
                  onClick={this.handlePrev}>
                  &lt;
                </button>
                {this.state.page}
                <button
                  disabled={this.isNextDisabled()}
                  onClick={this.handleNext}>
                  &gt;
                </button>
              </center>
              <div className="preview">
                {text}
              </div>
            </div>
          );
        }
      }

      class CodexApp extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            apiKey: 'UNLOCK_ALL'
          };
          this.handleChange = this.handleChange.bind(this);
          this.handleSubmit = this.handleSubmit.bind(this);
        }

        render() {
          return (
            <div>
              <h1>Codex</h1>
              <form onSubmit={this.handleSubmit}>
                <label htmlFor="new-todo">
                  API Key
                </label>
                <input
                  id="new-todo"
                  onChange={this.handleChange}
                  value={this.state.apiKey}
                />
                <button>
                  Load
                </button>
              </form>
            </div>
          );
        }

        handleChange(e) {
          this.setState({ text: e.target.value });
        }

        handleSubmit(e) {
          e.preventDefault();
          if (!this.state.apiKey.length) {
            return;
          }
          this.setState(state => ({
            apiKey: state.apiKey
          }));
          ReactDOM.render(
            <Shelf apiKey={this.state.apiKey} />,
            document.getElementById('root')
          );
        }
      }

      const testAchievementData = [
          {
            bits: [],
            current: 2,
            done: true,
            id: 1,
            max: 2
          },
          {
            bits: [1],
            current: 1,
            done: false,
            id: 2,
            max: 2
          },
        ];

      class Shelf extends React.Component {
        constructor(props) {
          super(props);
          this.apiKey = props.apiKey;
          this.state = {
            //achievements: [], isLoaded: false,
            achievements: testAchievementData, isLoaded: true,
            error: null,
            preview: null
          };
        }
        /**
        componentDidMount() {
          // TODO wrap this in an API-centric class/module
          var url = "https://api.guildwars2.com/v2/account/achievements?"
            + "ids=" + relevantAchievements.map(x => x["achievementId"]).join(",")
            + "&access_token=" + this.apiKey;
          fetch(url)
            .then(res => res.json())
            .then(
              (result) => {
                this.setState({
                  achievements: result,
                  isLoaded: true
                });
              },
              // Note: it's important to handle errors here
              // instead of a catch() block so that we don't swallow
              // exceptions from actual bugs in components.
              (error) => {
                this.setState({
                  isLoaded: true,
                  error
                });
              }
            )
        }
        */
        
        renderPreview() {
          var book = this.state.preview;
          if (book && book.type == "pages") {
            return (
              <PagedBookPreview book={book} />
            );
          }
          return (
            <BookPreview value={book} />
          );
        }
        
        previewBook(book) {
          var newState = {
            achievements: this.state.achievements,
            isLoaded: this.state.isLoaded,
            error: this.state.error,
            preview: book
          };
          this.setState(newState);
        }

        render() {
          const { error, isLoaded, achievements, preview } = this.state;
          if (error) {
            return <div>Error: {error.message}</div>;
          } else if (!isLoaded) {
            return <div>Loading...</div>;
          } else {
            // TODO map achievement ids to books
            var books = mapAchievementsToBooks(achievements);
            books.sort((x, y) => x["name"].localeCompare(y["name"]));
            return (
              <div className="codex">
                <div>
                  <h2>Shelf</h2>
                  <ul>
                    {books.map(book => (
                      <Book key={book.name} value={book} onClick={() => this.previewBook(book)} />
                    ))}
                  </ul>
                </div>
                {this.renderPreview()}
              </div>
            );
          }
        }
      }

      ReactDOM.render(
        <CodexApp />,
        document.getElementById('root')
      );

    </script>
    <!--
      Note: this page is a great way to try React but it's not suitable for production.
      It slowly compiles JSX with Babel in the browser and uses a large development build of React.

      Read this section for a production-ready setup with JSX:
      https://reactjs.org/docs/add-react-to-a-website.html#add-jsx-to-a-project

      In a larger project, you can use an integrated toolchain that includes JSX instead:
      https://reactjs.org/docs/create-a-new-react-app.html

      You can also use React without JSX, in which case you can remove Babel:
      https://reactjs.org/docs/react-without-jsx.html
    -->
  </body>
</html>